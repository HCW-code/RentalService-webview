<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>여러개 마커에 이벤트 등록하기2</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
      }
      .container {
        width: 100%;
        height: 100%;
      }
      .customoverlay {position:relative;border-radius:6px;border: 1px solid #ccc;border-bottom:2px solid #ddd;float:left;}
      .customoverlay:nth-of-type(n) {border:0; box-shadow:0px 1px 2px #888;}
      .customoverlay a {display:block;text-decoration:none;color:#000;text-align:center;border-radius:6px;font-size:14px;font-weight:bold;overflow:hidden;background: #d95050;background: #d95050 url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/arrow_white.png) no-repeat right 14px center;}
      .customoverlay .title1 {display:block;text-align:center;background:#fff;padding:5px 30px;font-size:14px;font-weight:bold;}
      .customoverlay .title2 {display:block;text-align:center;background:rgb(126, 143, 190);padding:5px 30px;font-size:14px;font-weight:bold;}
      .customoverlay:after {content:'';position:absolute;margin-left:-12px;left:50%;bottom:-12px;width:22px;height:12px;background:url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')}
    </style>
</head>
<body>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBsYlI4RsHi6jR5DOSeD5WTwDXqqXhhxP0",
      authDomain: "cstone-3dc2f.firebaseapp.com",
      databaseURL: "https://cstone-3dc2f-default-rtdb.firebaseio.com",
      projectId: "cstone-3dc2f",
      storageBucket: "cstone-3dc2f.appspot.com",
      messagingSenderId: "1088095057592",
      appId: "1:1088095057592:web:b01119cd7a31c6bc3b664d",
      measurementId: "G-LBGTN0FTR7"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  
  <div class="container" id="map"></div>

  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a1c356dafa15cfdde0ee381e29b49837"></script>
  <script>
    const db = firebase.firestore(); //firestore() 불러오기
    const store = db.collection("test");
    var list = null;
    var positions = [];
    var map;
    var search_point = [];

    asyncFunc();

    function fromFlutter(newTitle) {
        list = null;
        list = newTitle.split(",");
        console.log("위도"+list[1])
        if(Number(list[1]) != 0 && Number(list[2]) != 0){
            kakao_map(positions, map);
        }
    }

    async function asyncFunc(){
        var docRef = db.collection('test').get().then(결과 => {
            결과.forEach(doc => {
            positions.push(
                {
                content: '<div class="customoverlay">'+
                    '<span class="title1">'+
                        doc.data().name+ 
                        '<br>'+ 
                        doc.data().스키가격+
                        '</span>'+
                        '</div>',
                latlng : new kakao.maps.LatLng(doc.data().경도, doc.data().위도)
                })
            })
            console.log("첫 번째가 되야함")

            var mapContainer = document.getElementById('map'); // 지도를 표시할 div

            var mapOption = { 
                center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                level: 3 // 지도의 확대 레벨
            };
            
            map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
            console.log("안녕"+positions+"/"+map)
            return[positions,map];
        });

        code = await docRef;
        positions = code[0]; //위치 정보를 담는 변수 생성
        map = code[1];
        console.log("안녕2"+positions+","+map)
        kakao_map(positions, map);
    }

    function kakao_map(positions, map){
        var selectedMarker = null;    // 클릭한 마커를 담을 변수
        console.log("두 번째가 되야함")
        
        for (var i = 0; i < positions.length; i ++) {
            //커스텀 오버레이 엘리먼트에 컨텐츠 추가
            var normal_content = document.createElement('div'+i);
            var click_content = document.createElement('div'+i);
            normal_content.innerHTML = positions[i].content;
            click_content.innerHTML = positions[i].content.replace('title1', 'title2');
            
            // 마커를 생성합니다
            var normalOrigin = normal_content,
                clickOrigin = click_content;
                
            // 마커를 생성하고 지도위에 표시합니다
            addOverlay(i, map, positions[i].latlng, normalOrigin, clickOrigin)
        }
    
        
        // 마커를 생성하고 지도 위에 표시하고, 마커에 mouseover, mouseout, click 이벤트를 등록하는 함수입니다
        function addOverlay(store_id, map, position, normalOrigin, clickOrigin) {
            console.log("2"+map)
            console.log("3"+position)
            // 마커를 생성하고 이미지는 기본 마커 이미지를 사용합니다
            var customOverlay = new kakao.maps.CustomOverlay({
                map: map,
                position: position,
                content: normalOrigin,
                yAnchor: 1
            });
        
        //마커 클릭 이벤트
            // 마커 객체에 마커아이디와 마커의 기본 이미지를 추가합니다
            customOverlay.normalOrigin = normalOrigin;
            search_point[store_id] = normalOrigin;

            // 커스텀 오버레이에 mouseClick이벤트를 등록합니다 
            addEventHandle(normalOrigin, 'click', onMouseClick);
            addEventHandle(clickOrigin, 'click', onMouseClick);
            addEventHandle(document, 'click', onMouseClick_map);
            console.log(normalOrigin)
            
            if(list != null && store_id == list[0]){
                // 이동할 위도 경도 위치를 생성합니다 
                var moveLatLon = new kakao.maps.LatLng(list[1], list[2]);
                // 지도 중심을 이동 시킵니다
                map.setCenter(moveLatLon);
                search_point[Number(list[0])].click();
            }

            function onMouseClick(e) {
                // 커스텀 오버레이를 드래그 할 때, 내부 텍스트가 영역 선택되는 현상을 막아줍니다.
                if (e.preventDefault) {
                    e.preventDefault();
                } else {
                    e.returnValue = false;
                }
                console.log("발생!!")

                //부모 div까지 발생하는 클릭 이벤트 중지
                if (e.stopPropagation) e.stopPropagation();
                else e.cancelBubble = true; // IE 대응

                // 클릭된 마커가 없고, click 마커가 클릭된 마커가 아니면
                // 마커의 이미지를 클릭 이미지로 변경합니다
                if (selectedMarker == null || selectedMarker != customOverlay) {
                    console.log(customOverlay)
                    // 클릭된 마커 객체가 null이 아니면
                    // 클릭된 마커의 이미지를 기본 이미지로 변경하고
                    !!selectedMarker && selectedMarker.setContent(selectedMarker.normalOrigin);
                    
                    // 현재 클릭된 마커의 이미지는 클릭 이미지로 변경합니다
                    customOverlay.setContent(clickOrigin);

                    //클릭 이벤트가 발생했을 때 앱으로 해당 가게 정보를 보내준다.
                    const stateQuery = store.where("id", "==", store_id)
                    .get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                        // doc.data() is never undefined for query doc snapshots
                        var sned = doc.data().name+","+doc.data().address+","+doc.data().number+","+doc.data().스키가격
                        console.log(sned);
                        jams.postMessage(sned);
                        });
                    })
                    // 클릭된 마커를 현재 클릭된 마커 객체로 설정합니다
                    selectedMarker = customOverlay;
                }

                //클릭된 마커를 한번 더 클릭시 클릭 해제
                else if (selectedMarker != null || selectedMarker == customOverlay){
                  customOverlay.setContent(normalOrigin);
                  selectedMarker = null;
                  jams.postMessage("false");
                }
            }

            function onMouseClick_map(e) {
              //자식 div까지 발생하는 클릭 이벤트 중지
              if (e.stopImmediatePropagation) e.stopImmediatePropagation();
              else e.isImmediatePropagationEnabled = false;// IE 대응

              //클릭된 마커가 없으면 실행 X
              if(selectedMarker != null){
                !!selectedMarker && selectedMarker.setContent(selectedMarker.normalOrigin);
                selectedMarker = null;
                jams.postMessage("false");
              }
            }

            // target node에 이벤트 핸들러를 등록하는 함수힙니다  
            function addEventHandle(target, type, callback) {
                if (target.addEventListener) {
                    target.addEventListener(type, callback);
                } else {
                    target.attachEvent('on' + type, callback);
                }
            }

            // target node에 등록된 이벤트 핸들러를 제거하는 함수힙니다 
            function removeEventHandle(target, type, callback) {
                if (target.removeEventListener) {
                    target.removeEventListener(type, callback);
                } else {
                    target.detachEvent('on' + type, callback);
                }
            }
        }
    }

   </script>  
</body>
</html>